---
title: Human protein biomarkers, with clinical relevance inferred from Cerner RealWorldData
  via LOINC terms
author: "Jeremy Yang"
output:
  html_document:
    number_sections: yes
    toc: yes
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE)
base::date()
```

```{r setup, echo=FALSE, message=FALSE}
library(readr)
library(data.table)
library(plotly, quietly=T)
```

# LOINC codes for chemical tests (class = "CHEM")

```{r}
loinc_file <- "loinc_data/loinc_chem_names.tsv"
sprintf("LOINC codes for chemical tests: %s", loinc_file)
loinc_chem <- read_delim(loinc_file, "\t", escape_double=F)
setDT(loinc_chem)
sprintf("LOINC codes: %d", loinc_chem[, uniqueN(loinc_num)])
```

# NextMove LeadMine NER output using GeneAndProtein dictionary.

NER = named entity recognition, a form of text-mining.

## NER on LOINC field: "component".

```{r}
protein_NER_component_file <- "loinc_data/loinc_chem_names_2_NM_CFDictGeneAndProtein_leadmine.tsv"
sprintf("NextMove NER for LOINC-component: %s", protein_NER_component_file)
protein_NER_component <- read_delim(protein_NER_component_file, "\t")
setDT(protein_NER_component)
sprintf("LOINC codes mapped via component text to NER proteins: %d", protein_NER_component[, uniqueN(DocName)])
sprintf("LOINC codes resolved to standard IDs: %d / %d", protein_NER_component[!is.na(ResolvedForm), uniqueN(DocName)], protein_NER_component[, uniqueN(DocName)])
```

## NER on LOINC field: "relatednames2".

How many added by this field?

```{r}
protein_NER_relatednames_file <-  "loinc_data/loinc_chem_names_6_NM_CFDictGeneAndProtein_leadmine.tsv"
sprintf("NextMove NER for LOINC-relatednames: %s", protein_NER_relatednames_file)
protein_NER_relatednames <-  read_delim(protein_NER_relatednames_file, "\t")
setDT(protein_NER_relatednames)
sprintf("LOINC codes mapped via relatednames2 text to NER proteins: %d", protein_NER_relatednames[, uniqueN(DocName)])
sprintf("LOINC codes mapped via relatednames2 AND mapped via component: %d", length(intersect(protein_NER_relatednames[, DocName], protein_NER_component[, DocName])))
sprintf("LOINC codes mapped via relatednames2 NOT mapped via component: %d", length(setdiff(protein_NER_relatednames[, DocName], protein_NER_component[, DocName])))
sprintf("LOINC codes resolved to standard IDs: %d / %d", protein_NER_relatednames[!is.na(ResolvedForm), uniqueN(DocName)], protein_NER_relatednames[, uniqueN(DocName)])

```

# Cerner RWD counts

Cerner Real World Data 2023 counts of distinct encounter\_ids and patient\_ids for LOINC codes of class "CHEM". Each count is for a specific lab test, and year. There is a problem that some Cerner-coded lab tests merge to the same LOINC code, and the counts cannot be added, since there may be common patients and encounters. 

```{r}
rwd_loinc_counts <- read_csv("cerner_rwd_data/base_counts.csv")
setDT(rwd_loinc_counts)
rwd_loinc_counts <- rwd_loinc_counts[, .(loinc_code, mnemonic, loincclass, yr, count_encs, count_pts)]
rwd_loinc_counts <- unique(rwd_loinc_counts[loincclass == "CHEM"])
setorder(rwd_loinc_counts, loinc_code, yr)
sprintf("LOINC codes in RWD encounters: %d", rwd_loinc_counts[, uniqueN(loinc_code)])
sprintf("Number of labs tests which merge to a common LOINC, in 2021: %d / %d", sum(duplicated(rwd_loinc_counts[yr == "2021", .(loinc_code)])), nrow(rwd_loinc_counts[yr == "2021", .(loinc_code)]))
```

## Group lab procedures into list; aggregate on LOINC codes, first by year.

Some different labs have same LOINC codes. 

```{r}
rwd_loinc_counts <- rwd_loinc_counts[, .(
	mnemonics = paste(base::unique(c(mnemonic)), collapse="; "),
	loinc_class = "CHEM",
	encounter_id_count = sum(count_encs),
	patient_id_count = sum(count_pts)
	), by=c("loinc_code", "yr")]
rwd_loinc_counts_by_year <- rwd_loinc_counts[, .(
  encounters_mean = mean(encounter_id_count),
  patients_mean = mean(patient_id_count) 
	), by=c("yr")]
setorder(rwd_loinc_counts_by_year, yr)
plot_ly(rwd_loinc_counts_by_year, x=~yr, y = ~encounters_mean, type = "bar", name = "mean(nEn)") %>%
  add_trace(rwd_loinc_counts_by_year, x=~yr, y = ~patients_mean, type = "bar", name = "mean(nPt)")
```

## Combine years for totals.

Encounter ID counts can be added for multiple years, but not patient ID counts, since there can be common ID. When added over multiple labs, encounter ID counts should be interpreted as lab counts, since a single encounter can involve multiple labs.

```{r}
rwd_loinc_counts <- rwd_loinc_counts[, .(
	mnemonics,
	loinc_class,
	years = paste(sort(base::unique(c(yr))), collapse="; "),
	encounter_id_count,
	patient_id_count
	), by=c("loinc_code")]
```

# LOINC proteins in RWD encounters

```{r}
protein_hr_loincs_component <- merge(protein_NER_component, rwd_loinc_counts, by.x="DocName", by.y="loinc_code", all=F)
protein_hr_loincs_relatednames <- merge(protein_NER_relatednames, rwd_loinc_counts, by.x="DocName", by.y="loinc_code", all=F)
protein_hr_loincs <- rbind(protein_hr_loincs_component, protein_hr_loincs_relatednames)
sprintf("LOINC codes for proteins in RWD encounters: %d", protein_hr_loincs[, uniqueN(DocName)])
sprintf("LOINC protein names in RWD encounters: %d", protein_hr_loincs[, uniqueN(EntityText)])
```

## Group protein synonyms into list; aggregate on LOINC codes.

```{r}
protein_hr_loincs_out <- unique(protein_hr_loincs[, .(loinc_code=DocName, mnemonics, protein_name=EntityText, encounter_id_count, patient_id_count)])
protein_hr_loincs_out <- protein_hr_loincs_out[, .(mnemonics,
protein_names = paste(c(protein_name), collapse="; ")), by=c("loinc_code", "encounter_id_count", "patient_id_count")]
protein_hr_loincs_out <- unique(protein_hr_loincs_out)
setcolorder(protein_hr_loincs_out, c("loinc_code", "mnemonics", "protein_names", "encounter_id_count", "patient_id_count"))
```

# Top occurring LOINCs:

```{r}
protein_hr_loincs_out <- protein_hr_loincs_out[order(-encounter_id_count)]
write_delim(protein_hr_loincs_out, "cerner_hf_data/biomarkers_loinc_hf_out.tsv", delim="\t")
knitr::kable(protein_hr_loincs_out[1:50], caption="Top occurring LOINCs")
```

